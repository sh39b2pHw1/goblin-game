<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–æ–±–ª–∏–Ω –ö–ª–∏–∫–µ—Ä</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —à—Ä–∏—Ñ—Ç—ã Inter –∏–∑ Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è body, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å –æ—Ç—Å—Ç—É–ø—ã –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —à—Ä–∏—Ñ—Ç -->
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif; /* –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —à—Ä–∏—Ñ—Ç Inter */
            overflow-x: hidden; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É */
        }
    </style>
</head>
<body>
    <div id="root"></div> <!-- –≠—Ç–æ –º–µ—Å—Ç–æ, –∫—É–¥–∞ –±—É–¥–µ—Ç –º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞—à–µ React-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º React –∏ ReactDOM –∏–∑ CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Babel –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è JSX –≤ JavaScript –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.
         –í —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–±–æ—Ä—â–∏–∫ (Webpack/Vite) –¥–ª—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –∑–∞—Ä–∞–Ω–µ–µ.
         –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –≤ –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º Babel –≤ –±—Ä–∞—É–∑–µ—Ä–µ. -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- –ù–∞—à React-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç App, –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –Ω–∞–ø—Ä—è–º—É—é -->
    <!-- –í–∞–∂–Ω–æ: type="text/babel" –≥–æ–≤–æ—Ä–∏—Ç Babel, —á—Ç–æ —ç—Ç–æ JS —Å JSX, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞—Ç—å -->
    <script type="text/babel">
        // –ò–º–ø–æ—Ä—Ç—ã React Hooks –∏ Firebase SDK
        const { useState, useEffect, useRef } = React;
        const { initializeApp } = firebase; // –î–æ—Å—Ç—É–ø –∫ firebase –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏
        const { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = firebase.auth;
        const { getFirestore } = firebase.firestore;

        function App() {
          // Game state variables
          const [playerGold, setPlayerGold] = useState(0);
          const [currentLevel, setCurrentLevel] = useState(1);
          const [currentMonsterHP, setCurrentMonsterHP] = useState(0);
          const [maxMonsterHP, setMaxMonsterHP] = useState(0);
          const [message, setMessage] = useState("–ù–∞–∂–º–∏ –Ω–∞ –≥–æ–±–ª–∏–Ω–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å!");
          const [isAuthReady, setIsAuthReady] = useState(false); // State to track Firebase auth readiness
          const [clickDamage, setClickDamage] = useState(1); // New state for player's click damage
          const [upgradeClickCost, setUpgradeClickCost] = useState(10); // Initial cost for click damage upgrade

          // Firebase variables
          const dbRef = useRef(null);
          const authRef = useRef(null);
          const userIdRef = useRef(null);

          // Initialize Firebase and set up auth listener
          useEffect(() => {
            try {
              // Access global variables provided by the Canvas environment
              const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
              const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
              const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

              if (firebaseConfig) {
                const app = initializeApp(firebaseConfig);
                dbRef.current = getFirestore(app);
                authRef.current = getAuth(app);

                // Sign in anonymously or with custom token
                const signIn = async () => {
                  try {
                    if (initialAuthToken) {
                      await signInWithCustomToken(authRef.current, initialAuthToken);
                    } else {
                      await signInAnonymously(authRef.current);
                    }
                    console.log("Firebase Auth initialized.");
                  } catch (error) {
                    console.error("Firebase Auth error:", error);
                  }
                };
                signIn();

                // Listen for authentication state changes
                const unsubscribe = onAuthStateChanged(authRef.current, (user) => {
                  if (user) {
                    userIdRef.current = user.uid;
                    console.log("User ID:", userIdRef.current);
                  } else {
                    // If no user (e.g., anonymous sign-in failed or token expired)
                    userIdRef.current = crypto.randomUUID(); // Generate a random ID for unauthenticated users
                    console.log("No authenticated user, using random ID:", userIdRef.current);
                  }
                  setIsAuthReady(true); // Set auth ready after initial check
                });

                return () => unsubscribe(); // Cleanup auth listener on unmount
              } else {
                console.warn("Firebase config not found. Running without Firebase.");
                setIsAuthReady(true); // Still set auth ready for non-Firebase run
              }
            } catch (error) {
              console.error("Error initializing Firebase:", error);
              setIsAuthReady(true); // Ensure game can still start even if Firebase init fails
            }
          }, []);

          // Function to initialize a new monster
          const initializeNewMonster = (level) => {
            const hp = level * 10 + 50; // HP increases with level
            setCurrentMonsterHP(hp);
            setMaxMonsterHP(hp);
            setMessage(`–ü–æ—è–≤–∏–ª—Å—è –≥–æ–±–ª–∏–Ω –£—Ä. ${level}!`);
          };

          // Effect to initialize the first monster when auth is ready
          useEffect(() => {
            if (isAuthReady && maxMonsterHP === 0) { // Only initialize if auth is ready and no monster is set
              initializeNewMonster(currentLevel);
            }
          }, [isAuthReady, currentLevel, maxMonsterHP]);

          // Handle monster click
          const handleMonsterClick = () => {
            if (currentMonsterHP <= 0) {
              // If monster is already defeated, wait for new one to appear
              return;
            }

            const newHP = currentMonsterHP - clickDamage; // Use clickDamage here
            setCurrentMonsterHP(newHP);

            if (newHP <= 0) {
              // Monster defeated!
              const goldEarned = currentLevel * 5; // Earn more gold for higher level monsters
              setPlayerGold(prevGold => prevGold + goldEarned);
              setMessage(`–ì–æ–±–ª–∏–Ω –ø–æ–≤–µ—Ä–∂–µ–Ω! –í—ã –ø–æ–ª—É—á–∏–ª–∏ ${goldEarned} –∑–æ–ª–æ—Ç–∞.`);

              // Level up and spawn new monster after a short delay
              setTimeout(() => {
                const nextLevel = currentLevel + 1;
                setCurrentLevel(nextLevel);
                initializeNewMonster(nextLevel);
              }, 1000); // 1 second delay before new monster appears
            }
          };

          // Handle buying upgrades
          const handleBuyClickDamageUpgrade = () => {
            if (playerGold >= upgradeClickCost) {
              setPlayerGold(prevGold => prevGold - upgradeClickCost);
              setClickDamage(prevDamage => prevDamage + 1); // Increase damage by 1
              setUpgradeClickCost(prevCost => Math.floor(prevCost * 1.5)); // Increase cost for next upgrade
              setMessage(`–í—ã –∫—É–ø–∏–ª–∏ –£—Å–∏–ª–µ–Ω–Ω—ã–π –∫–ª–∏–∫! –£—Ä–æ–Ω –∑–∞ –∫–ª–∏–∫: ${clickDamage + 1}`);
            } else {
              setMessage("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–æ–ª–æ—Ç–∞ –¥–ª—è —ç—Ç–æ–≥–æ —É–ª—É—á—à–µ–Ω–∏—è!");
            }
          };

          // Calculate HP bar percentage
          const hpPercentage = maxMonsterHP > 0 ? (currentMonsterHP / maxMonsterHP) * 100 : 0;

          // Show loading while Firebase auth is not ready
          if (!isAuthReady) {
            return (
              <div className="flex items-center justify-center min-h-screen bg-gray-900 text-white">
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä—ã...</p>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gradient-to-br from-gray-900 to-gray-700 text-white font-inter flex flex-col items-center justify-center p-4">
              {/* Game Title */}
              <h1 className="text-5xl md:text-6xl font-bold mb-8 text-yellow-400 drop-shadow-lg text-center">
                –ì–æ–±–ª–∏–Ω –ö–ª–∏–∫–µ—Ä
              </h1>

              {/* Game Stats */}
              <div className="bg-gray-800 p-6 rounded-2xl shadow-xl mb-8 w-full max-w-md flex flex-col items-center justify-center space-y-4">
                <p className="text-2xl font-semibold">–ó–æ–ª–æ—Ç–æ: <span className="text-yellow-300">{playerGold}</span></p>
                <p className="text-2xl font-semibold">–£—Ä–æ–≤–µ–Ω—å: <span className="text-green-400">{currentLevel}</span></p>
                <p className="text-2xl font-semibold">–£—Ä–æ–Ω –∑–∞ –∫–ª–∏–∫: <span className="text-purple-400">{clickDamage}</span></p>
                {userIdRef.current && (
                    <p className="text-sm text-gray-400 break-all text-center">–í–∞—à ID: {userIdRef.current}</p>
                )}
              </div>

              {/* Monster Area */}
              <div
                className="relative bg-red-800 p-8 rounded-2xl shadow-2xl transition-transform duration-100 active:scale-95 cursor-pointer flex flex-col items-center justify-center transform hover:scale-105"
                onClick={handleMonsterClick}
                style={{ minWidth: '250px', minHeight: '250px' }} // Ensure a minimum size
              >
                <div className="absolute top-4 left-4 right-4 text-center text-xl font-bold">
                  –ì–æ–±–ª–∏–Ω –£—Ä. {currentLevel}
                </div>
                <p className="text-8xl md:text-9xl mb-4 select-none">üßå</p> {/* Goblin Emoji */}

                <!-- HP Bar -->
                <div className="w-full bg-gray-600 rounded-full h-4 mt-2 overflow-hidden border-2 border-red-500">
                  <div
                    className="bg-red-500 h-full rounded-full transition-all duration-300"
                    style={{ width: `${hpPercentage}%` }}
                  ></div>
                </div>
                <div className="text-lg font-bold mt-2">{currentMonsterHP} / {maxMonsterHP} HP</div>
              </div>

              <!-- Game Message -->
              <div className="bg-blue-800 p-4 rounded-2xl shadow-lg mt-8 w-full max-w-md text-center text-xl font-medium">
                {message}
              </div>

              <!-- Upgrade Shop -->
              <div className="bg-gray-800 p-6 rounded-2xl shadow-xl mt-8 w-full max-w-md">
                <h2 className="text-3xl font-bold mb-4 text-center text-blue-300">–ú–∞–≥–∞–∑–∏–Ω –£–ª—É—á—à–µ–Ω–∏–π</h2>
                <div className="flex flex-col items-center space-y-4">
                  <button
                    onClick={handleBuyClickDamageUpgrade}
                    className={`w-full py-3 px-6 rounded-xl text-xl font-bold
                      ${playerGold >= upgradeClickCost ? 'bg-green-600 hover:bg-green-700 active:bg-green-800' : 'bg-gray-500 cursor-not-allowed'}
                      text-white transition-all duration-200 shadow-md transform hover:scale-105`}
                    disabled={playerGold < upgradeClickCost}
                  >
                    –£—Å–∏–ª–µ–Ω–Ω—ã–π –∫–ª–∏–∫ (+1 —É—Ä–æ–Ω) - {upgradeClickCost} üí∞
                  </button>
                </div>
              </div>

              <!-- Tailwind CSS Script - Always include this in the body or head for HTML/React apps -->
              <script src="https://cdn.tailwindcss.com"></script>
            </div>
          );
        }

        // –ú–æ–Ω—Ç–∏—Ä—É–µ–º –Ω–∞—à–µ React-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ div —Å id="root"
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
    <!-- Firebase SDKs for Browser -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</body>
</html>
